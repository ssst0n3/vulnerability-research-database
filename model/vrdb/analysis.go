package vrdb

import (
	"github.com/ssst0n3/vulnerability-research-database/model/osv"
	"gorm.io/gorm"
)

type Analysis struct {
	gorm.Model
	Credits         []Credit        `json:"credits" gorm:"many2many:analysis_credits;"`
	Version         string          `json:"version"`
	Url             string          `json:"url"`
	Vulnerabilities []Vulnerability `json:"vulnerabilities" gorm:"many2many:vulnerability_analyses"`
}

func (a Analysis) OSV() *osv.Analysis {
	var credits []osv.Credit
	for _, credit := range a.Credits {
		credits = append(credits, *credit.OSV())
	}
	return &osv.Analysis{
		Credits: credits,
		Version: a.Version,
		Url:     a.Url,
	}
}

func NewAnalysis(o osv.Analysis) *Analysis {
	return &Analysis{
		Credits: NewCredits(o.Credits),
		Version: o.Version,
		Url:     o.Url,
	}
}
func NewAnalyses(o []osv.Analysis) (analyses []Analysis) {
	for _, analysis := range o {
		analyses = append(analyses, *NewAnalysis(analysis))
	}
	return
}
